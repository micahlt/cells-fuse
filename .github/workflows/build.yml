name: Assemble platform binaries

on:
#  push:
#    branches: [main, master]
#  pull_request:
#    branches: [main, master]
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build for Linux x64'
        required: true
        type: boolean
        default: true
      build_mac_intel:
        description: 'Build for macOS Intel'
        required: true
        type: boolean
        default: true
      build_mac_arm:
        description: 'Build for macOS ARM (Apple Silicon)'
        required: true
        type: boolean
        default: true
      build_windows:
        description: 'Build for Windows'
        required: true
        type: boolean
        default: true
        
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            input_key: build_linux
            arch: x64
          - os: macos-15-intel
            platform: macos
            input_key: build_mac_intel
            arch: intel
          - os: macos-15
            platform: macos
            input_key: build_mac_arm
            arch: arm64
          - os: windows-latest
            platform: windows
            input_key: build_windows
            arch: arm64

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        if: github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]
        uses: actions/checkout@v4

      - name: Set up Go
        if: github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install Linux dependencies
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev libfuse3-dev gcc libgtk-4-dev libgirepository1.0-dev libgraphene-1.0-dev libgtk-4-dev libayatana-appindicator3-dev

      - name: Install macOS dependencies
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && matrix.platform == 'macos'
        run: |
          brew install macfuse gtk4 gtk+3 gobject-introspection pkg-config

      - name: Set up MSYS2
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && matrix.platform == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-pkg-config

      - name: Set up WinFSP
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && matrix.platform == 'windows'
        run: |
          $headers = @{
              Authorization = "token ${{ secrets.GITHUB_TOKEN }}"
          }
          $releases = Invoke-WebRequest https://api.github.com/repos/winfsp/winfsp/releases -Headers $headers | `
              ConvertFrom-Json

          $asseturi = $releases[0].assets.browser_download_url | `
              Where-Object { $_ -match "winfsp-.*\.msi" }
          Invoke-WebRequest -Uri $asseturi -Out winfsp.msi
          Start-Process -NoNewWindow -Wait msiexec "/i winfsp.msi /qn INSTALLLEVEL=1000"
          
      - name: Gather Go modules
        if: github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]
        run: |
          go mod download
          go get cells-fuse

      - name: Build
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && (matrix.platform == 'linux' || matrix.platform == 'macos')
        run: |
          env GO111MODULE=on go build -v -o cells-fuse_${{ matrix.platform }}-${{ matrix.arch }} .

      - name: Build
        if: (github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]) && matrix.platform == 'windows'
        shell: cmd
        run: |
          set CPATH=C:\Program Files (x86)\WinFsp\inc\fuse
          go build -ldflags="-H windowsgui" .

      - name: Upload artifact
        if: github.event_name != 'workflow_dispatch' || inputs[matrix.input_key]
        uses: actions/upload-artifact@v4
        with:
          name: cells-fuse_${{ matrix.platform }}-${{ matrix.arch }}
          path: cells-fuse_${{ matrix.platform }}-${{ matrix.arch }}
          retention-days: 30
